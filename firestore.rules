rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is admin
    // In a real production app with many admins, use Custom Claims.
    // For this strict requirement, we verify email against a hardcoded whitelist.
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.email in ['kumarjithazra@gmail.com'];
    }

    // USERS collection
    // Users can read/write their own profile
    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // OPPORTUNITIES collection
    // Public Read: Only if verified
    // Admin Write: Only admins can write (create/update/delete)
    match /opportunities/{opportunityId} {
      // Allow read if the document is verified.
      // Note: Queries must filter by verified == 'verified' for this rule to work on lists.
      allow read: if resource.data.verified == 'verified';
      
      // Only admins can write
      allow write: if isAdmin();
    }

    // SOURCES collection
    // Admin only
    match /sources/{sourceId} {
      allow read, write: if isAdmin();
    }

    // TRACKING collection
    // User owns document. The document ID IS NOT required to be the userId, 
    // but the 'userId' field in the document MUST match the auth uid.
    match /tracking/{trackingId} {
      // Read: Own docs
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Create: user must set their own userId
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Update: user must own the existing doc AND not change the userId field
      allow update: if isAuthenticated() 
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.userId == request.auth.uid;

      // Delete: user must own the doc
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // Deny access to everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}