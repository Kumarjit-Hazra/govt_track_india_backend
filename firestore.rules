rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is admin (using custom claims or a specific ID list)
    // For this MVP, we will assume an 'admin' claim or specific UID logic if provided.
    // Since we don't have custom claims setup in the prompt, strict admin via Rules is hard without it.
    // However, the prompt says "admins ... can write opportunities". 
    // We'll trust that admin writing happens via Cloud Functions (Admin SDK) which BYPASSES these rules.
    // So "admin write" in rules usually means "deny direct client write".
    // Therefore, for collections where ONLY admin writes: allow write: if false;

    // USERS collection
    // "user owns document"
    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // OPPORTUNITIES collection
    // "admin write, public read (verified only)"
    match /opportunities/{opportunityId} {
      // allow read: if resource.data.verified == 'verified'; 
      // But for query filters to work, the rule must match the query.
      // If client queries where verified == 'verified', this is safe.
      allow read: if resource.data.verified == 'verified';
      
      // Admin writes via Admin SDK (Cloud Functions), so we block client writes.
      allow write: if false;
    }

    // SOURCES collection
    // "admin only"
    match /sources/{sourceId} {
      allow read, write: if false; // Only manageable via Admin SDK
    }

    // TRACKING collection
    // "user owns document" -> userId field must match auth.uid
    match /tracking/{trackingId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // "can write only their own tracking"
      // Ensure the data being written has userId matching auth.uid
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // SYSTEM collection
    // "admin only"
    match /system/{docId} {
      allow read, write: if false;
    }
  }
}